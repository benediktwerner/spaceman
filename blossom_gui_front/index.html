<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Blossom</title>
    <link data-trunk rel="css" href="src/style.css"/>
</head>
<body>
    <script>
        async function f() {
            const {invoke} = window.__TAURI__;
            const {emit, listen} = window.__TAURI__.event;

            window.invoke = invoke;
            window.emit = emit;

            await invoke("add_protobuf_descriptor", {"path": "/home/elia/code/blossom/playground/proto/playground.desc"});
            console.log("Repo", JSON.parse(await invoke("get_repo_view", {})));

            window.startCall = async (callId, methodSerial, metadata = []) => {
                await listen(`o-${callId}`, msg => {
                    console.log("Output", msg.event, JSON.parse(msg.payload));
                });
                await invoke("start_call", {
                    callId,
                    endpointEncoded: JSON.stringify({authority: "localhost:7575"}),
                    methodSerial,
                    metadata
                });
            };

            window.message = async (callId, msg) => {
                await emit(`i-${callId}`, {Msg: JSON.stringify(msg)});
            };
            window.commit = async callId => {
                await emit(`i-${callId}`, JSON.stringify("Commit"));
            };
            window.cancel = async callId => {
                await emit(`i-${callId}`, JSON.stringify("Cancel"));
            };
        }
        f();
    </script>
</body>
</html>
